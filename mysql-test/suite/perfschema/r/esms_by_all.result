TRUNCATE TABLE performance_schema.events_statements_summary_by_all;
create user user_super@localhost identified by 'su';
grant all on *.* to user_super@localhost with grant option;
Case 1: performance_schema_esms_by_all=off
select @@performance_schema_esms_by_all;
@@performance_schema_esms_by_all
0
select 42;
42
42
select schema_name, digest, user, client_id, plan_id, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_all;
schema_name	digest	user	client_id	plan_id	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
select schema_name, digest, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_digest;
schema_name	digest	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
test	3237dac9486d0be6dda852ff087e5f89	1	0	0	0	TRUNCATE TABLE `performance_schema` . `events_statements_summary_by_all`
test	6b262aae8b24a6e9a49a9fdad290a25d	1	0	1	0	CREATE SYSTEM_USER `user_super` @? IDENTIFIED BY ?
test	252f5231e1e9a8b8e04f5f6179e4f7ed	1	0	36	1	GRANT ALL ON * . * TO `user_super` @? WITH GRANT OPTION
test	aaee6b4d5f9c26d4d43d3967f53cd8c7	1	0	0	0	SELECT @@`performance_schema_esms_by_all`
test	a532c6f3e890282b7eee77f35ee85ae9	1	0	0	0	SELECT ?
test	c6743192a895b6c4484951dd3e2b87ff	1	0	0	0	SELECT SCHEMA_NAME , `digest` , SYSTEM_USER , `client_id` , `plan_id` , `count_star` , `sum_rows_deleted` , `sum_rows_inserted` , `sum_rows_updated` , `digest_text` FROM `performance_schema` . `events_statements_summary_by_all`
Case 2: sql_stats_control=ON
set global performance_schema_esms_by_all = on;
select @@performance_schema_esms_by_all;
@@performance_schema_esms_by_all
1
select schema_name, digest, user, client_id, plan_id, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_all;
schema_name	digest	user	client_id	plan_id	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
test	1bdaf02b6c6dd4f5bfc3045555865597	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SET GLOBAL `performance_schema_esms_by_all` = ON
test	aaee6b4d5f9c26d4d43d3967f53cd8c7	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SELECT @@`performance_schema_esms_by_all`
select schema_name, digest, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_digest;
schema_name	digest	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
select 1;
1
1
select 2;
2
2
select 100;
100
100
select schema_name, digest, user, client_id, plan_id, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_all;
schema_name	digest	user	client_id	plan_id	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
test	1bdaf02b6c6dd4f5bfc3045555865597	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SET GLOBAL `performance_schema_esms_by_all` = ON
test	aaee6b4d5f9c26d4d43d3967f53cd8c7	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SELECT @@`performance_schema_esms_by_all`
test	c6743192a895b6c4484951dd3e2b87ff	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SELECT SCHEMA_NAME , `digest` , SYSTEM_USER , `client_id` , `plan_id` , `count_star` , `sum_rows_deleted` , `sum_rows_inserted` , `sum_rows_updated` , `digest_text` FROM `performance_schema` . `events_statements_summary_by_all`
test	eef40448e52f0ab20b5eb7b25d323f17	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SELECT SCHEMA_NAME , `digest` , `count_star` , `sum_rows_deleted` , `sum_rows_inserted` , `sum_rows_updated` , `digest_text` FROM `performance_schema` . `events_statements_summary_by_digest`
test	a532c6f3e890282b7eee77f35ee85ae9	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	3	0	0	0	SELECT ?
select schema_name, digest, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_digest;
schema_name	digest	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
create table t1(c int);
insert into t1 values(1);
insert into t1 values(2);
insert into t1 values(3);
insert into t1 values(4);
insert into t1 values(5);
update t1 set c=c+100;
update t1 set c=c+300;
update t1 set c=c+500;
delete from t1 where c=905;
delete from t1 where c=903;
select schema_name, digest, user, client_id, plan_id, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_all;
schema_name	digest	user	client_id	plan_id	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
test	1bdaf02b6c6dd4f5bfc3045555865597	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SET GLOBAL `performance_schema_esms_by_all` = ON
test	aaee6b4d5f9c26d4d43d3967f53cd8c7	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SELECT @@`performance_schema_esms_by_all`
test	c6743192a895b6c4484951dd3e2b87ff	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	2	0	0	0	SELECT SCHEMA_NAME , `digest` , SYSTEM_USER , `client_id` , `plan_id` , `count_star` , `sum_rows_deleted` , `sum_rows_inserted` , `sum_rows_updated` , `digest_text` FROM `performance_schema` . `events_statements_summary_by_all`
test	eef40448e52f0ab20b5eb7b25d323f17	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	2	0	0	0	SELECT SCHEMA_NAME , `digest` , `count_star` , `sum_rows_deleted` , `sum_rows_inserted` , `sum_rows_updated` , `digest_text` FROM `performance_schema` . `events_statements_summary_by_digest`
test	a532c6f3e890282b7eee77f35ee85ae9	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	3	0	0	0	SELECT ?
test	d210d88fff8eeea1393763fdcc68c999	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	12	6	CREATE TABLE `t1` ( `c` INTEGER )
test	de4ac3f385e51f51f081f37368d6e55f	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	5	0	5	0	INSERT INTO `t1` VALUES (?)
test	437f75e69680d60cca3e8a82393fa4f1	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	3	0	0	15	UPDATE `t1` SET `c` = `c` + ?
test	3379f8d08c8ef1406d99c65ff9b6b097	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	2	2	0	0	DELETE FROM `t1` WHERE `c` = ?
select schema_name, digest, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_digest;
schema_name	digest	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
Case 3: TRUNCATE TABLE
TRUNCATE TABLE performance_schema.events_statements_summary_by_all;
select 1 union select 2;
1
1
2
select 1 union select 2 union select 3;
1
1
2
3
select schema_name, digest, user, client_id, plan_id, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_all;
schema_name	digest	user	client_id	plan_id	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
test	3237dac9486d0be6dda852ff087e5f89	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	TRUNCATE TABLE `performance_schema` . `events_statements_summary_by_all`
test	7e393507a197a79395cb5c88376cb2d3	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	2	0	SELECT ? UNION SELECT ?
test	351069bf91b28ffff52fb54d89de9e45	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	3	0	SELECT ? UNION SELECT ? UNION SELECT ?
select schema_name, digest, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_digest;
schema_name	digest	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
Case 4: performance_schema_esms_by_all=off. No data in events_statements_summary_by_all.
set global performance_schema_esms_by_all = off;
select @@performance_schema_esms_by_all;
@@performance_schema_esms_by_all
0
select schema_name, digest, user, client_id, plan_id, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_all;
schema_name	digest	user	client_id	plan_id	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
select schema_name, digest, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_digest;
schema_name	digest	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
test	ceffef89a77026913c52137e9c7a3615	1	0	0	0	SET GLOBAL `performance_schema_esms_by_all` = OFF
test	aaee6b4d5f9c26d4d43d3967f53cd8c7	1	0	0	0	SELECT @@`performance_schema_esms_by_all`
test	c6743192a895b6c4484951dd3e2b87ff	1	0	0	0	SELECT SCHEMA_NAME , `digest` , SYSTEM_USER , `client_id` , `plan_id` , `count_star` , `sum_rows_deleted` , `sum_rows_inserted` , `sum_rows_updated` , `digest_text` FROM `performance_schema` . `events_statements_summary_by_all`
Case 6: Multi-query support
set global performance_schema_esms_by_all = on;
select @@performance_schema_esms_by_all;
@@performance_schema_esms_by_all
1
select 1;
create table t2(c int);
insert into t2 values(100);
select * from t2;
update t2 set c=c+7;
delete from t2 where c=107;
drop table t2;
||||
1
1
c
100
select schema_name, digest, user, client_id, plan_id, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_all;
schema_name	digest	user	client_id	plan_id	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
test	1bdaf02b6c6dd4f5bfc3045555865597	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SET GLOBAL `performance_schema_esms_by_all` = ON
test	aaee6b4d5f9c26d4d43d3967f53cd8c7	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SELECT @@`performance_schema_esms_by_all`
test	a532c6f3e890282b7eee77f35ee85ae9	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SELECT ?
test	08eb447c2908ae85dbf2389bb755a47c	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	12	6	CREATE TABLE `t2` ( `c` INTEGER )
test	ea8d7221939e31cd79bb5a0800f1c421	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	1	0	INSERT INTO `t2` VALUES (?)
test	9355f873b85ca62c15f9c76c7d577a46	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	0	SELECT * FROM `t2`
test	37a4ab3f20bfa2cadc339f81a225a3ea	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	0	0	1	UPDATE `t2` SET `c` = `c` + ?
test	c6b47f584c3c723a695af80568462861	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	1	0	0	DELETE FROM `t2` WHERE `c` = ?
test	0092392cb59149e0726b0b82c62d3b73	user_super	99914b932bd37a50b983c5e7c90ae93b	00000000000000000000000000000000	1	12	0	0	DROP TABLE `t2`
select schema_name, digest, count_star, sum_rows_deleted, sum_rows_inserted, sum_rows_updated, digest_text from performance_schema.events_statements_summary_by_digest;
schema_name	digest	count_star	sum_rows_deleted	sum_rows_inserted	sum_rows_updated	digest_text
Cleanup
set global performance_schema_esms_by_all = DEFAULT;
drop table t1;
drop user user_super@localhost;
