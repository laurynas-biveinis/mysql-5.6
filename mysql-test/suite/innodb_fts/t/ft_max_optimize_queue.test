--echo #
--echo # Verify the queue size does not grow too large
--echo #

--echo # Disable for valgrind because this takes too long
--source include/not_valgrind.inc

CREATE DATABASE mysqlslap;
USE mysqlslap;
CREATE TABLE t1 ( `id` int unsigned NOT NULL AUTO_INCREMENT, `col01` TEXT, `col02` TEXT, `col03` TEXT, `col04` TEXT, `col05` TEXT, `col06` TEXT, `col07` TEXT, `col08` TEXT, `col09` TEXT, `col10` TEXT, `col11` TEXT, `col12` TEXT, `col13` TEXT, `col14` TEXT, `col15` TEXT, `col16` TEXT, `col17` TEXT, `col18` TEXT, `col19` TEXT, `col20` TEXT, `col21` TEXT, `col22` TEXT, `col23` TEXT, `col24` TEXT, `col25` TEXT, `col26` TEXT, `col27` TEXT, `col28` TEXT, `col29` TEXT, `col30` TEXT, PRIMARY KEY (`id`), FULLTEXT KEY (`col01`), FULLTEXT KEY (`col02`), FULLTEXT KEY (`col03`), FULLTEXT KEY (`col04`), FULLTEXT KEY (`col05`), FULLTEXT KEY (`col06`), FULLTEXT KEY (`col07`), FULLTEXT KEY (`col08`), FULLTEXT KEY (`col09`), FULLTEXT KEY (`col10`), FULLTEXT KEY (`col11`), FULLTEXT KEY (`col12`), FULLTEXT KEY (`col13`), FULLTEXT KEY (`col14`), FULLTEXT KEY (`col15`), FULLTEXT KEY (`col16`), FULLTEXT KEY (`col17`), FULLTEXT KEY (`col18`), FULLTEXT KEY (`col19`), FULLTEXT KEY (`col20`), FULLTEXT KEY (`col21`), FULLTEXT KEY (`col22`), FULLTEXT KEY (`col23`), FULLTEXT KEY (`col24`), FULLTEXT KEY (`col25`), FULLTEXT KEY (`col26`), FULLTEXT KEY (`col27`), FULLTEXT KEY (`col28`), FULLTEXT KEY (`col29`), FULLTEXT KEY (`col30`)) ENGINE=INNODB;
CREATE TABLE t2 ( `id` int unsigned NOT NULL AUTO_INCREMENT, `col01` TEXT, `col02` TEXT, `col03` TEXT, `col04` TEXT, `col05` TEXT, `col06` TEXT, `col07` TEXT, `col08` TEXT, `col09` TEXT, `col10` TEXT, `col11` TEXT, `col12` TEXT, `col13` TEXT, `col14` TEXT, `col15` TEXT, `col16` TEXT, `col17` TEXT, `col18` TEXT, `col19` TEXT, `col20` TEXT, `col21` TEXT, `col22` TEXT, `col23` TEXT, `col24` TEXT, `col25` TEXT, `col26` TEXT, `col27` TEXT, `col28` TEXT, `col29` TEXT, `col30` TEXT, PRIMARY KEY (`id`), FULLTEXT KEY (`col01`), FULLTEXT KEY (`col02`), FULLTEXT KEY (`col03`), FULLTEXT KEY (`col04`), FULLTEXT KEY (`col05`), FULLTEXT KEY (`col06`), FULLTEXT KEY (`col07`), FULLTEXT KEY (`col08`), FULLTEXT KEY (`col09`), FULLTEXT KEY (`col10`), FULLTEXT KEY (`col11`), FULLTEXT KEY (`col12`), FULLTEXT KEY (`col13`), FULLTEXT KEY (`col14`), FULLTEXT KEY (`col15`), FULLTEXT KEY (`col16`), FULLTEXT KEY (`col17`), FULLTEXT KEY (`col18`), FULLTEXT KEY (`col19`), FULLTEXT KEY (`col20`), FULLTEXT KEY (`col21`), FULLTEXT KEY (`col22`), FULLTEXT KEY (`col23`), FULLTEXT KEY (`col24`), FULLTEXT KEY (`col25`), FULLTEXT KEY (`col26`), FULLTEXT KEY (`col27`), FULLTEXT KEY (`col28`), FULLTEXT KEY (`col29`), FULLTEXT KEY (`col30`)) ENGINE=INNODB;
CREATE TABLE t3 ( `id` int unsigned NOT NULL AUTO_INCREMENT, `col01` TEXT, `col02` TEXT, `col03` TEXT, `col04` TEXT, `col05` TEXT, `col06` TEXT, `col07` TEXT, `col08` TEXT, `col09` TEXT, `col10` TEXT, `col11` TEXT, `col12` TEXT, `col13` TEXT, `col14` TEXT, `col15` TEXT, `col16` TEXT, `col17` TEXT, `col18` TEXT, `col19` TEXT, `col20` TEXT, `col21` TEXT, `col22` TEXT, `col23` TEXT, `col24` TEXT, `col25` TEXT, `col26` TEXT, `col27` TEXT, `col28` TEXT, `col29` TEXT, `col30` TEXT, PRIMARY KEY (`id`), FULLTEXT KEY (`col01`), FULLTEXT KEY (`col02`), FULLTEXT KEY (`col03`), FULLTEXT KEY (`col04`), FULLTEXT KEY (`col05`), FULLTEXT KEY (`col06`), FULLTEXT KEY (`col07`), FULLTEXT KEY (`col08`), FULLTEXT KEY (`col09`), FULLTEXT KEY (`col10`), FULLTEXT KEY (`col11`), FULLTEXT KEY (`col12`), FULLTEXT KEY (`col13`), FULLTEXT KEY (`col14`), FULLTEXT KEY (`col15`), FULLTEXT KEY (`col16`), FULLTEXT KEY (`col17`), FULLTEXT KEY (`col18`), FULLTEXT KEY (`col19`), FULLTEXT KEY (`col20`), FULLTEXT KEY (`col21`), FULLTEXT KEY (`col22`), FULLTEXT KEY (`col23`), FULLTEXT KEY (`col24`), FULLTEXT KEY (`col25`), FULLTEXT KEY (`col26`), FULLTEXT KEY (`col27`), FULLTEXT KEY (`col28`), FULLTEXT KEY (`col29`), FULLTEXT KEY (`col30`)) ENGINE=INNODB;

SET @save = @@global.innodb_ft_max_optimize_queue_size;
SET GLOBAL innodb_ft_max_optimize_queue_size = 24;

--exec $MYSQL_SLAP --silent --concurrency=8 --delimiter=";" --number-of-queries=1024 --query='INSERT INTO t1 ( `col01`, `col02`, `col03`, `col04`, `col05`, `col06`, `col07`, `col08`, `col09`, `col10`, `col11`, `col12`, `col13`, `col14`, `col15`, `col16`, `col17`, `col18`, `col19`, `col20`, `col21`, `col22`, `col23`, `col24`, `col25`, `col26`, `col27`, `col28`, `col29`, `col30`) VALUES ( MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND())); INSERT INTO t2 ( `col01`, `col02`, `col03`, `col04`, `col05`, `col06`, `col07`, `col08`, `col09`, `col10`, `col11`, `col12`, `col13`, `col14`, `col15`, `col16`, `col17`, `col18`, `col19`, `col20`, `col21`, `col22`, `col23`, `col24`, `col25`, `col26`, `col27`, `col28`, `col29`, `col30`) VALUES ( MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND())); INSERT INTO t3 ( `col01`, `col02`, `col03`, `col04`, `col05`, `col06`, `col07`, `col08`, `col09`, `col10`, `col11`, `col12`, `col13`, `col14`, `col15`, `col16`, `col17`, `col18`, `col19`, `col20`, `col21`, `col22`, `col23`, `col24`, `col25`, `col26`, `col27`, `col28`, `col29`, `col30`) VALUES ( MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()), MD5(RAND()));'

--let $assert_text = Queue should be capped
--let $assert_cond= [SHOW GLOBAL STATUS LIKE "Innodb_ft_optimize_queue_count", Value, 1] <= 64
--source include/assert.inc

SET GLOBAL innodb_ft_max_optimize_queue_size = @save;

DROP DATABASE mysqlslap;
