set fb_vector_search_limit_multiplier=1;
CREATE TABLE t1 (
id BIGINT NOT NULL PRIMARY KEY,
vector1 JSON NOT NULL fb_vector_dimension 4,
name varchar(64),
INDEX key1(vector1) FB_VECTOR_INDEX_TYPE 'ivfpq' FB_VECTOR_TRAINED_INDEX_TABLE 'VECTORDB_DATA' FB_VECTOR_TRAINED_INDEX_ID 'id1'
);

verify index config info in INFORMATION_SCHEMA
SELECT INDEX_TYPE, CODE_SIZE, NLIST, PQ_M, PQ_NBITS FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
INDEX_TYPE	CODE_SIZE	NLIST	PQ_M	PQ_NBITS
ivfpq	4	4	4	8

populate test data
insert into t1 (WITH RECURSIVE a(i) AS (SELECT 0 union all select i+1 from a where i < 99) SELECT i, json_array(6.66+i*0.0001, 5.45-i*0.0001, 0, 0), concat('val', i) from a);
insert into t1 (WITH RECURSIVE a(i) AS (SELECT 0 union all select i+1 from a where i < 49) SELECT i+1000, json_array(9.52+i*0.0001, 7.79-i*0.0001, 0, 0), concat('val', i+1000) from a);

select *, fb_vector_l2(vector1, '[3, 2]')  as dis from t1 order by dis limit 10;
id	vector1	name	dis
63	[6.6663, 5.4437, 0, 0]	val63	25.300823211669922
64	[6.6664, 5.4436, 0, 0]	val64	25.300870895385742
65	[6.6665, 5.4435, 0, 0]	val65	25.300914764404297
0	[6.66, 5.45, 0, 0]	val0	25.298095703125
1	[6.6601, 5.4499, 0, 0]	val1	25.298141479492188
2	[6.6602, 5.4498, 0, 0]	val2	25.298185348510742
3	[6.6603, 5.4497, 0, 0]	val3	25.29822540283203
4	[6.6604, 5.4496, 0, 0]	val4	25.298269271850586
5	[6.6605, 5.4495, 0, 0]	val5	25.298311233520508
6	[6.6606, 5.4494, 0, 0]	val6	25.298355102539062
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
150	1	0	100	37

test update, move id 0 to centroid 3, id 1 to centroid 2
update t1 set vector1='[1.249, 1.022, 0, 0]' where id=0;
update t1 set vector1='[3.7, 3.05, 0, 0]' where id=1;
select *, fb_vector_l2(vector1, '[3, 2]')  as dis from t1 order by dis limit 10;
id	vector1	name	dis
1	[3.7, 3.05, 0, 0]	val1	1.5924999713897705
0	[1.249, 1.022, 0, 0]	val0	4.022485256195068
63	[6.6663, 5.4437, 0, 0]	val63	25.300823211669922
64	[6.6664, 5.4436, 0, 0]	val64	25.300870895385742
65	[6.6665, 5.4435, 0, 0]	val65	25.300914764404297
2	[6.6602, 5.4498, 0, 0]	val2	25.298185348510742
3	[6.6603, 5.4497, 0, 0]	val3	25.29822540283203
4	[6.6604, 5.4496, 0, 0]	val4	25.298269271850586
5	[6.6605, 5.4495, 0, 0]	val5	25.298311233520508
6	[6.6606, 5.4494, 0, 0]	val6	25.298355102539062
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
150	2	1	98	37

test delete, delete id 64
delete from t1 where id=64;
select *, fb_vector_l2(vector1, '[3, 2]')  as dis from t1 order by dis limit 10;
id	vector1	name	dis
1	[3.7, 3.05, 0, 0]	val1	1.5924999713897705
0	[1.249, 1.022, 0, 0]	val0	4.022485256195068
63	[6.6663, 5.4437, 0, 0]	val63	25.300823211669922
65	[6.6665, 5.4435, 0, 0]	val65	25.300914764404297
2	[6.6602, 5.4498, 0, 0]	val2	25.298185348510742
3	[6.6603, 5.4497, 0, 0]	val3	25.29822540283203
4	[6.6604, 5.4496, 0, 0]	val4	25.298269271850586
5	[6.6605, 5.4495, 0, 0]	val5	25.298311233520508
6	[6.6606, 5.4494, 0, 0]	val6	25.298355102539062
7	[6.6607, 5.4493, 0, 0]	val7	25.29839324951172
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
149	3	1	97	37

test ip
select *, fb_vector_ip(vector1, '[3, 2]')  as dis from t1 order by dis desc limit 10;
id	vector1	name	dis
1038	[9.5238, 7.7862, 0, 0]	val1038	44.143798828125
1037	[9.5237, 7.7863, 0, 0]	val1037	44.143699645996094
1036	[9.5236, 7.7864, 0, 0]	val1036	44.14360046386719
1035	[9.5235, 7.7865, 0, 0]	val1035	44.14350128173828
1034	[9.5234, 7.7866, 0, 0]	val1034	44.143402099609375
1033	[9.5233, 7.7867, 0, 0]	val1033	44.1432991027832
1032	[9.5232, 7.7868, 0, 0]	val1032	44.1431999206543
1031	[9.5231, 7.7869, 0, 0]	val1031	44.14310073852539
1030	[9.5230, 7.7870, 0, 0]	val1030	44.143001556396484
1029	[9.5229, 7.7871, 0, 0]	val1029	44.14289855957031
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
149	4	1	97	37
drop table t1;
blob column test
set fb_vector_search_limit_multiplier=1;
CREATE TABLE t1 (
id BIGINT NOT NULL PRIMARY KEY,
blob1 BLOB NOT NULL fb_vector_dimension 4,
name varchar(64),
INDEX key1(blob1) FB_VECTOR_INDEX_TYPE 'ivfpq' FB_VECTOR_TRAINED_INDEX_TABLE 'VECTORDB_DATA' FB_VECTOR_TRAINED_INDEX_ID 'id1'
);

verify index config info in INFORMATION_SCHEMA
SELECT INDEX_TYPE, CODE_SIZE, NLIST, PQ_M, PQ_NBITS FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
INDEX_TYPE	CODE_SIZE	NLIST	PQ_M	PQ_NBITS
ivfpq	4	4	4	8

populate test data
insert into t1 (WITH RECURSIVE a(i) AS (SELECT 0 union all select i+1 from a where i < 99) SELECT i, FB_VECTOR_JSON_TO_BLOB(json_array(6.66+i*0.0001, 5.45-i*0.0001, 0, 0)), concat('val', i) from a);
insert into t1 (WITH RECURSIVE a(i) AS (SELECT 0 union all select i+1 from a where i < 49) SELECT i+1000, FB_VECTOR_JSON_TO_BLOB(json_array(9.52+i*0.0001, 7.79-i*0.0001, 0, 0)), concat('val', i+1000) from a);

select id, FB_VECTOR_BLOB_TO_JSON(blob1), name, fb_vector_l2(blob1, '[3, 2]')  as dis from t1 order by dis limit 10;
id	FB_VECTOR_BLOB_TO_JSON(blob1)	name	dis
63	[6.666299819946289, 5.443699836730957, 0.0, 0.0]	val63	25.300823211669922
64	[6.666399955749512, 5.443600177764893, 0.0, 0.0]	val64	25.300870895385742
65	[6.666500091552734, 5.44350004196167, 0.0, 0.0]	val65	25.300914764404297
0	[6.659999847412109, 5.449999809265137, 0.0, 0.0]	val0	25.298095703125
1	[6.660099983215332, 5.449900150299072, 0.0, 0.0]	val1	25.298141479492188
2	[6.660200119018555, 5.44980001449585, 0.0, 0.0]	val2	25.298185348510742
3	[6.660299777984619, 5.449699878692627, 0.0, 0.0]	val3	25.29822540283203
4	[6.660399913787842, 5.4496002197265625, 0.0, 0.0]	val4	25.298269271850586
5	[6.6605000495910645, 5.44950008392334, 0.0, 0.0]	val5	25.298311233520508
6	[6.660600185394287, 5.449399948120117, 0.0, 0.0]	val6	25.298355102539062
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
150	1	0	100	37

test update, move id 0 to centroid 3, id 1 to centroid 2
update t1 set blob1=FB_VECTOR_JSON_TO_BLOB('[1.249, 1.022, 0, 0]') where id=0;
update t1 set blob1=FB_VECTOR_JSON_TO_BLOB('[3.7, 3.05, 0, 0]') where id=1;
select id, FB_VECTOR_BLOB_TO_JSON(blob1), name, fb_vector_l2(blob1, '[3, 2]')  as dis from t1 order by dis limit 10;
id	FB_VECTOR_BLOB_TO_JSON(blob1)	name	dis
1	[3.700000047683716, 3.049999952316284, 0.0, 0.0]	val1	1.5924999713897705
0	[1.2489999532699585, 1.0219999551773071, 0.0, 0.0]	val0	4.022485256195068
63	[6.666299819946289, 5.443699836730957, 0.0, 0.0]	val63	25.300823211669922
64	[6.666399955749512, 5.443600177764893, 0.0, 0.0]	val64	25.300870895385742
65	[6.666500091552734, 5.44350004196167, 0.0, 0.0]	val65	25.300914764404297
2	[6.660200119018555, 5.44980001449585, 0.0, 0.0]	val2	25.298185348510742
3	[6.660299777984619, 5.449699878692627, 0.0, 0.0]	val3	25.29822540283203
4	[6.660399913787842, 5.4496002197265625, 0.0, 0.0]	val4	25.298269271850586
5	[6.6605000495910645, 5.44950008392334, 0.0, 0.0]	val5	25.298311233520508
6	[6.660600185394287, 5.449399948120117, 0.0, 0.0]	val6	25.298355102539062
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
150	2	1	98	37

test delete, delete id 64
delete from t1 where id=64;
select id, FB_VECTOR_BLOB_TO_JSON(blob1), name, fb_vector_l2(blob1, '[3, 2]')  as dis from t1 order by dis limit 10;
id	FB_VECTOR_BLOB_TO_JSON(blob1)	name	dis
1	[3.700000047683716, 3.049999952316284, 0.0, 0.0]	val1	1.5924999713897705
0	[1.2489999532699585, 1.0219999551773071, 0.0, 0.0]	val0	4.022485256195068
63	[6.666299819946289, 5.443699836730957, 0.0, 0.0]	val63	25.300823211669922
65	[6.666500091552734, 5.44350004196167, 0.0, 0.0]	val65	25.300914764404297
2	[6.660200119018555, 5.44980001449585, 0.0, 0.0]	val2	25.298185348510742
3	[6.660299777984619, 5.449699878692627, 0.0, 0.0]	val3	25.29822540283203
4	[6.660399913787842, 5.4496002197265625, 0.0, 0.0]	val4	25.298269271850586
5	[6.6605000495910645, 5.44950008392334, 0.0, 0.0]	val5	25.298311233520508
6	[6.660600185394287, 5.449399948120117, 0.0, 0.0]	val6	25.298355102539062
7	[6.660699844360352, 5.4492998123168945, 0.0, 0.0]	val7	25.29839324951172
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
149	3	1	97	37

test ip
select id, FB_VECTOR_BLOB_TO_JSON(blob1), name, fb_vector_ip(blob1, '[3, 2]')  as dis from t1 order by dis desc limit 10;
id	FB_VECTOR_BLOB_TO_JSON(blob1)	name	dis
1038	[9.523799896240234, 7.786200046539307, 0.0, 0.0]	val1038	44.143798828125
1037	[9.523699760437012, 7.786300182342529, 0.0, 0.0]	val1037	44.143699645996094
1036	[9.523599624633789, 7.786399841308594, 0.0, 0.0]	val1036	44.14360046386719
1035	[9.523500442504883, 7.786499977111816, 0.0, 0.0]	val1035	44.14350128173828
1034	[9.52340030670166, 7.786600112915039, 0.0, 0.0]	val1034	44.143402099609375
1033	[9.523300170898438, 7.7866997718811035, 0.0, 0.0]	val1033	44.1432991027832
1032	[9.523200035095215, 7.786799907684326, 0.0, 0.0]	val1032	44.1431999206543
1031	[9.523099899291992, 7.786900043487549, 0.0, 0.0]	val1031	44.14310073852539
1030	[9.52299976348877, 7.7870001792907715, 0.0, 0.0]	val1030	44.143001556396484
1029	[9.522899627685547, 7.787099838256836, 0.0, 0.0]	val1029	44.14289855957031
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
149	4	1	97	37
drop table t1;
