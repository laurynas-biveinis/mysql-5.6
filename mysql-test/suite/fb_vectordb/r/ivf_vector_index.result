insert into VECTORDB_DATA values ('id1', 'metadata', 0, JSON_OBJECT('version', 1)), ('id1', 'quantizer', 0, '[0, 0, 0, 0]'), ('id1', 'quantizer', 1, '[1, 1, 0, 0]');
CREATE TABLE t1 (
id BIGINT NOT NULL PRIMARY KEY,
vector1 JSON,
name varchar(64),
INDEX key1(vector1) FB_VECTOR_INDEX_TYPE 'ivfflat' fb_vector_dimension 4 FB_VECTOR_TRAINED_INDEX_TABLE 'VECTORDB_DATA' FB_VECTOR_TRAINED_INDEX_ID 'id1'
);
insert into t1 (WITH RECURSIVE a(i) AS (SELECT 0 union all select i+1 from a where i < 99) SELECT i, json_array(i*0.0001, i*0.0001), concat('val', i) from a);
insert into t1 (WITH RECURSIVE a(i) AS (SELECT 0 union all select i+1 from a where i < 99) SELECT i+1000, json_array(1+i*0.0001, 1-i*0.0001), concat('val', i+1000) from a);
select *, fb_vector_l2(vector1, '[0.3, 0.3]')  as dis from t1 order by dis limit 10;
id	vector1	name	dis
99	[0.0099, 0.0099]	val99	0.1683160364627838
98	[0.0098, 0.0098]	val98	0.1684321016073227
97	[0.0097, 0.0097]	val97	0.16854819655418396
96	[0.0096, 0.0096]	val96	0.16866432130336761
95	[0.0095, 0.0095]	val95	0.16878052055835724
94	[0.0094, 0.0094]	val94	0.16889671981334686
93	[0.0093, 0.0093]	val93	0.16901300847530365
92	[0.0092, 0.0092]	val92	0.16912928223609924
91	[0.0091, 0.0091]	val91	0.169245645403862
90	[0.0090, 0.0090]	val90	0.16936200857162476
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
200	1	100	100	100
update t1 set vector1 = '[0.0097, 0.009]' where id = 98;
select *, fb_vector_l2(vector1, '[0.3, 0.3]')  as dis from t1 order by dis limit 10;
id	vector1	name	dis
99	[0.0099, 0.0099]	val99	0.1683160364627838
97	[0.0097, 0.0097]	val97	0.16854819655418396
96	[0.0096, 0.0096]	val96	0.16866432130336761
95	[0.0095, 0.0095]	val95	0.16878052055835724
94	[0.0094, 0.0094]	val94	0.16889671981334686
98	[0.0097, 0.009]	val98	0.16895510256290436
93	[0.0093, 0.0093]	val93	0.16901300847530365
92	[0.0092, 0.0092]	val92	0.16912928223609924
91	[0.0091, 0.0091]	val91	0.169245645403862
90	[0.0090, 0.0090]	val90	0.16936200857162476
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
200	2	100	100	100
update t1 set id = 2000 where id = 98;
select *, fb_vector_l2(vector1, '[0.3, 0.3]')  as dis from t1 order by dis limit 10;
id	vector1	name	dis
99	[0.0099, 0.0099]	val99	0.1683160364627838
97	[0.0097, 0.0097]	val97	0.16854819655418396
96	[0.0096, 0.0096]	val96	0.16866432130336761
95	[0.0095, 0.0095]	val95	0.16878052055835724
94	[0.0094, 0.0094]	val94	0.16889671981334686
2000	[0.0097, 0.009]	val98	0.16895510256290436
93	[0.0093, 0.0093]	val93	0.16901300847530365
92	[0.0092, 0.0092]	val92	0.16912928223609924
91	[0.0091, 0.0091]	val91	0.169245645403862
90	[0.0090, 0.0090]	val90	0.16936200857162476
update t1 set vector1 = '[0.0098, 0.0099]', id = 2001 where id = 2000;
select *, fb_vector_l2(vector1, '[0.3, 0.3]')  as dis from t1 order by dis limit 10;
id	vector1	name	dis
99	[0.0099, 0.0099]	val99	0.1683160364627838
2001	[0.0098, 0.0099]	val98	0.16837406158447266
97	[0.0097, 0.0097]	val97	0.16854819655418396
96	[0.0096, 0.0096]	val96	0.16866432130336761
95	[0.0095, 0.0095]	val95	0.16878052055835724
94	[0.0094, 0.0094]	val94	0.16889671981334686
93	[0.0093, 0.0093]	val93	0.16901300847530365
92	[0.0092, 0.0092]	val92	0.16912928223609924
91	[0.0091, 0.0091]	val91	0.169245645403862
90	[0.0090, 0.0090]	val90	0.16936200857162476
update t1 set vector1 = '[1.0001, 1]' where id = 92;
select *, fb_vector_l2(vector1, '[0.3, 0.3]')  as dis from t1 order by dis limit 10;
id	vector1	name	dis
99	[0.0099, 0.0099]	val99	0.1683160364627838
2001	[0.0098, 0.0099]	val98	0.16837406158447266
97	[0.0097, 0.0097]	val97	0.16854819655418396
96	[0.0096, 0.0096]	val96	0.16866432130336761
95	[0.0095, 0.0095]	val95	0.16878052055835724
94	[0.0094, 0.0094]	val94	0.16889671981334686
93	[0.0093, 0.0093]	val93	0.16901300847530365
91	[0.0091, 0.0091]	val91	0.169245645403862
90	[0.0090, 0.0090]	val90	0.16936200857162476
89	[0.0089, 0.0089]	val89	0.16947844624519348
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
200	5	99	101	100

delete vector from centroid 0
delete from t1 where id = 99;
99 should disappear from query result
select *, fb_vector_l2(vector1, '[0.3, 0.3]')  as dis from t1 order by dis limit 10;
id	vector1	name	dis
2001	[0.0098, 0.0099]	val98	0.16837406158447266
97	[0.0097, 0.0097]	val97	0.16854819655418396
96	[0.0096, 0.0096]	val96	0.16866432130336761
95	[0.0095, 0.0095]	val95	0.16878052055835724
94	[0.0094, 0.0094]	val94	0.16889671981334686
93	[0.0093, 0.0093]	val93	0.16901300847530365
91	[0.0091, 0.0091]	val91	0.169245645403862
90	[0.0090, 0.0090]	val90	0.16936200857162476
89	[0.0089, 0.0089]	val89	0.16947844624519348
88	[0.0088, 0.0088]	val88	0.1695948988199234
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
199	6	98	101	99

results from centroid 1
select *, fb_vector_l2(vector1, '[0.6, 0.6]')  as dis from t1 order by dis limit 10;
id	vector1	name	dis
1000	[1, 1]	val1000	0.31999996304512024
1001	[1.0001, 0.9999]	val1001	0.3199999928474426
1002	[1.0002, 0.9998]	val1002	0.3200001120567322
1003	[1.0003, 0.9997]	val1003	0.32000017166137695
1004	[1.0004, 0.9996]	val1004	0.32000023126602173
1005	[1.0005, 0.9995]	val1005	0.32000041007995605
1006	[1.0006, 0.9994]	val1006	0.32000067830085754
1007	[1.0007, 0.9993]	val1007	0.32000094652175903
1008	[1.0008, 0.9992]	val1008	0.3200012445449829
1009	[1.0009, 0.9991]	val1009	0.32000163197517395
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
199	7	98	101	99

delete vector from centroid 1
delete from t1 where id = 1001;
1001 should disappear from query result
select *, fb_vector_l2(vector1, '[0.6, 0.6]')  as dis from t1 order by dis limit 10;
id	vector1	name	dis
1000	[1, 1]	val1000	0.31999996304512024
1002	[1.0002, 0.9998]	val1002	0.3200001120567322
1003	[1.0003, 0.9997]	val1003	0.32000017166137695
1004	[1.0004, 0.9996]	val1004	0.32000023126602173
1005	[1.0005, 0.9995]	val1005	0.32000041007995605
1006	[1.0006, 0.9994]	val1006	0.32000067830085754
1007	[1.0007, 0.9993]	val1007	0.32000094652175903
1008	[1.0008, 0.9992]	val1008	0.3200012445449829
1009	[1.0009, 0.9991]	val1009	0.32000163197517395
1010	[1.0010, 0.9990]	val1010	0.320002019405365
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
198	8	98	100	99
select *, fb_vector_ip(vector1, '[1, 1]') as dis from t1 order by dis desc limit 10;
id	vector1	name	dis
92	[1.0001, 1]	val92	2.0001001358032227
1099	[1.0099, 0.9901]	val1099	2
1098	[1.0098, 0.9902]	val1098	2
1097	[1.0097, 0.9903]	val1097	2
1096	[1.0096, 0.9904]	val1096	2
1095	[1.0095, 0.9905]	val1095	2
1094	[1.0094, 0.9906]	val1094	2
1093	[1.0093, 0.9907]	val1093	2
1092	[1.0092, 0.9908]	val1092	2
1091	[1.0091, 0.9909]	val1091	2
SELECT NTOTAL, HIT, MIN_LIST_SIZE, MAX_LIST_SIZE, AVG_LIST_SIZE  FROM INFORMATION_SCHEMA.ROCKSDB_VECTOR_INDEX WHERE TABLE_NAME = 't1';
NTOTAL	HIT	MIN_LIST_SIZE	MAX_LIST_SIZE	AVG_LIST_SIZE
198	9	98	100	99
drop table t1;
