CREATE TABLE t1 (   
pk BIGINT NOT NULL PRIMARY KEY,
vector1 JSON NOT NULL FB_VECTOR_DIMENSION 3,
INDEX vector_key_1(vector1) FB_VECTOR_INDEX_TYPE 'flat' 
);
insert into t1 values (1, '[1, 1, 1]'), (2, '[2, 2, 2]'), (3, '[3, 3, 3]'), 
(4, '[4, 4, 4]'), (5, '[5, 5, 5]'), (6, '[6, 6, 6]');
insert into t1 values (7, '[11, 1, 1]'), (8, '[21, 2, 2]'), (9, '[31, 3, 3]'), 
(10, '[41, 4, 4]'), (11, '[51, 5, 5]'), (12, '[61, 6, 6]');

Record value of fb_vector_index_cond_pushdown
SELECT @@SESSION.fb_vector_index_cond_pushdown;
@@SESSION.fb_vector_index_cond_pushdown
1

Vector distance ordering for reference:
explain
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 order by dis limit 100;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	index	NULL	vector_key_1	65535	NULL	1	100.00	NULL
Warnings:
Note	1003	/* select#1 */ select `test`.`t1`.`pk` AS `pk`,`test`.`t1`.`vector1` AS `vector1`,fb_vector_l2(`test`.`t1`.`vector1`,'[12.5, 3.5, 2.5]') AS `dis` from `test`.`t1` order by `dis` limit 100
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 order by dis limit 100;
pk	vector1	dis
7	[11, 1, 1]	10.75
6	[6, 6, 6]	60.75
5	[5, 5, 5]	64.75
4	[4, 4, 4]	74.75
8	[21, 2, 2]	74.75
3	[3, 3, 3]	90.75
2	[2, 2, 2]	112.75
1	[1, 1, 1]	140.75
9	[31, 3, 3]	342.75
10	[41, 4, 4]	814.75
11	[51, 5, 5]	1490.75
12	[61, 6, 6]	2370.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	12	12

open ended range 
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk > 4 order by dis limit 10;
pk	vector1	dis
7	[11, 1, 1]	10.75
6	[6, 6, 6]	60.75
5	[5, 5, 5]	64.75
8	[21, 2, 2]	74.75
9	[31, 3, 3]	342.75
10	[41, 4, 4]	814.75
11	[51, 5, 5]	1490.75
12	[61, 6, 6]	2370.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	8	8

bounded range
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk >= 5 and pk < 10 order by dis limit 10;
pk	vector1	dis
7	[11, 1, 1]	10.75
6	[6, 6, 6]	60.75
5	[5, 5, 5]	64.75
8	[21, 2, 2]	74.75
9	[31, 3, 3]	342.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	5	5

IN list
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk in (1, 3, 5) order by dis limit 10;
pk	vector1	dis
5	[5, 5, 5]	64.75
3	[3, 3, 3]	90.75
1	[1, 1, 1]	140.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	3	3

IN list with EQ condition
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk in (1, 5) or pk = '3' order by dis limit 10;
pk	vector1	dis
5	[5, 5, 5]	64.75
3	[3, 3, 3]	90.75
1	[1, 1, 1]	140.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	3	3

IN list with LIKE clause
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk in (1, 5) or pk like '1%' order by dis limit 10;
pk	vector1	dis
5	[5, 5, 5]	64.75
1	[1, 1, 1]	140.75
10	[41, 4, 4]	814.75
11	[51, 5, 5]	1490.75
12	[61, 6, 6]	2370.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	5	5
drop table t1;
CREATE TABLE t1 (   
pk_keypart_1 BIGINT NOT NULL,
pk_keypart_2 INT NOT NULL,
vector1 JSON NOT NULL FB_VECTOR_DIMENSION 3,
PRIMARY KEY(pk_keypart_1, pk_keypart_2),
INDEX vector_key_1(vector1) FB_VECTOR_INDEX_TYPE 'flat' 
);
insert into t1 values (1, 11, '[1, 1, 1]'), (2, 11, '[2, 2, 2]'), (3, 11, '[3, 3, 3]'), 
(4, 11, '[4, 4, 4]'), (5, 11, '[5, 5, 5]'), (6, 11, '[6, 6, 6]');
insert into t1 values (7, 112, '[11, 1, 1]'), (8, 112, '[21, 2, 2]'), (9, 112, '[31, 3, 3]'), 
(10, 112, '[41, 4, 4]'), (11, 112, '[51, 5, 5]'), (12, 112, '[61, 6, 6]');

Vector distance ordering for reference:
explain
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 order by dis limit 100;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	SIMPLE	t1	NULL	index	NULL	vector_key_1	65535	NULL	1	100.00	NULL
Warnings:
Note	1003	/* select#1 */ select `test`.`t1`.`pk_keypart_1` AS `pk_keypart_1`,`test`.`t1`.`pk_keypart_2` AS `pk_keypart_2`,`test`.`t1`.`vector1` AS `vector1`,fb_vector_l2(`test`.`t1`.`vector1`,'[12.5, 3.5, 2.5]') AS `dis` from `test`.`t1` order by `dis` limit 100
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 order by dis limit 100;
pk_keypart_1	pk_keypart_2	vector1	dis
7	112	[11, 1, 1]	10.75
6	11	[6, 6, 6]	60.75
5	11	[5, 5, 5]	64.75
4	11	[4, 4, 4]	74.75
8	112	[21, 2, 2]	74.75
3	11	[3, 3, 3]	90.75
2	11	[2, 2, 2]	112.75
1	11	[1, 1, 1]	140.75
9	112	[31, 3, 3]	342.75
10	112	[41, 4, 4]	814.75
11	112	[51, 5, 5]	1490.75
12	112	[61, 6, 6]	2370.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	12	12

open ended range 
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk_keypart_1 > 4 order by dis limit 10;
pk_keypart_1	pk_keypart_2	vector1	dis
7	112	[11, 1, 1]	10.75
6	11	[6, 6, 6]	60.75
5	11	[5, 5, 5]	64.75
8	112	[21, 2, 2]	74.75
9	112	[31, 3, 3]	342.75
10	112	[41, 4, 4]	814.75
11	112	[51, 5, 5]	1490.75
12	112	[61, 6, 6]	2370.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	8	8

bounded range
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk_keypart_1 >= 5 and pk_keypart_1 < 10 order by dis limit 10;
pk_keypart_1	pk_keypart_2	vector1	dis
7	112	[11, 1, 1]	10.75
6	11	[6, 6, 6]	60.75
5	11	[5, 5, 5]	64.75
8	112	[21, 2, 2]	74.75
9	112	[31, 3, 3]	342.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	5	5

IN list
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk_keypart_1 in (1, 3, 5) order by dis limit 10;
pk_keypart_1	pk_keypart_2	vector1	dis
5	11	[5, 5, 5]	64.75
3	11	[3, 3, 3]	90.75
1	11	[1, 1, 1]	140.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	3	3

IN list with EQ condition
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk_keypart_1 in (1, 5) or pk_keypart_1 = '3' order by dis limit 10;
pk_keypart_1	pk_keypart_2	vector1	dis
5	11	[5, 5, 5]	64.75
3	11	[3, 3, 3]	90.75
1	11	[1, 1, 1]	140.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	3	3

IN list with LIKE clause
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk_keypart_1 in (1, 5) or pk_keypart_1 like '1%' order by dis limit 10;
pk_keypart_1	pk_keypart_2	vector1	dis
5	11	[5, 5, 5]	64.75
1	11	[1, 1, 1]	140.75
10	112	[41, 4, 4]	814.75
11	112	[51, 5, 5]	1490.75
12	112	[61, 6, 6]	2370.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	5	5

Filter on pk_keypart_2 EQ condition (negative test)
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk_keypart_2 = '115'  order by dis limit 10;
pk_keypart_1	pk_keypart_2	vector1	dis

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	0	0

Filter on pk_keypart_2 through IN list 
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk_keypart_2 in (11, 15)  order by dis limit 10;
pk_keypart_1	pk_keypart_2	vector1	dis
6	11	[6, 6, 6]	60.75
5	11	[5, 5, 5]	64.75
4	11	[4, 4, 4]	74.75
3	11	[3, 3, 3]	90.75
2	11	[2, 2, 2]	112.75
1	11	[1, 1, 1]	140.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	6	6

Filter on pk_keypart_1 LIKE clause and pk_keypart_2 open range condition
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk_keypart_2 > 20 and pk_keypart_1 like '1%' order by dis limit 10;
pk_keypart_1	pk_keypart_2	vector1	dis
10	112	[41, 4, 4]	814.75
11	112	[51, 5, 5]	1490.75
12	112	[61, 6, 6]	2370.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	3	3

Filter on pk_keypart_1 bounded range condition and pk_keypart_2 LIKE clause
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk_keypart_1 > 3 and pk_keypart_1 <= 10 and  pk_keypart_2 like '%2' order by dis limit 10;
pk_keypart_1	pk_keypart_2	vector1	dis
7	112	[11, 1, 1]	10.75
8	112	[21, 2, 2]	74.75
9	112	[31, 3, 3]	342.75
10	112	[41, 4, 4]	814.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	4	4

Turn PK pre-filtering OFF and check results
SELECT @@SESSION.fb_vector_index_cond_pushdown;
@@SESSION.fb_vector_index_cond_pushdown
1
SET @@SESSION.fb_vector_index_cond_pushdown = false;
select *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk_keypart_2 > 20 and pk_keypart_1 like '1%' order by dis limit 10;
pk_keypart_1	pk_keypart_2	vector1	dis
10	112	[41, 4, 4]	814.75
11	112	[51, 5, 5]	1490.75
12	112	[61, 6, 6]	2370.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	12	12

Turn PK pre-filtering ON through query hint and check results
SELECT @@SESSION.fb_vector_index_cond_pushdown;
@@SESSION.fb_vector_index_cond_pushdown
0
select /*+ SET_VAR(fb_vector_index_cond_pushdown=ON) */ *, fb_vector_l2(vector1, '[12.5, 3.5, 2.5]') as dis from t1 where pk_keypart_2 > 20 and pk_keypart_1 like '1%' order by dis limit 10;
pk_keypart_1	pk_keypart_2	vector1	dis
10	112	[41, 4, 4]	814.75
11	112	[51, 5, 5]	1490.75
12	112	[61, 6, 6]	2370.75

select INDEX_NUMBER, TABLE_SCHEMA, TABLE_NAME, INDEX_NAME, INDEX_TYPE, 
MIN_LIST_SIZE, MAX_LIST_SIZE from information_schema.ROCKSDB_VECTOR_INDEX;
INDEX_NUMBER	TABLE_SCHEMA	TABLE_NAME	INDEX_NAME	INDEX_TYPE	MIN_LIST_SIZE	MAX_LIST_SIZE
IDX	test	t1	vector_key_1	flat	3	3
SET @@SESSION.fb_vector_index_cond_pushdown = true;
drop table t1;
